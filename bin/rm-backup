#!/bin/bash
#
# rm-backup - Backup reMarkable tablet and export annotations
#
# Usage: rm-backup [--no-svg]
#

set -euo pipefail

# Determine script location
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
TABLET="${REMARKABLE_IP:-10.11.99.1}"

# Flags
EXPORT_SVG=true
[[ "${1:-}" == "--no-svg" ]] && EXPORT_SVG=false

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

info() { echo -e "${BLUE}==>${NC} $*"; }
success() { echo -e "${GREEN}OK${NC} $*"; }
warn() { echo -e "${YELLOW}!${NC} $*"; }
error() { echo -e "${RED}X${NC} $*"; exit 1; }

cd "$SCRIPT_DIR"

# Check connection
info "Connecting to $TABLET..."
if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "root@$TABLET" exit 2>/dev/null; then
    error "Cannot connect. Is tablet connected via USB?"
fi

# Backup
info "Syncing xochitl data..."
rsync -av --delete \
    --exclude '*.tombstone' \
    --exclude '*.thumbnails/' \
    --exclude '*.cache' \
    "root@$TABLET:/home/root/.local/share/remarkable/xochitl/" \
    "$SCRIPT_DIR/xochitl/"
success "Data synced"

# Export
if [[ "$EXPORT_SVG" == true && -f "$SCRIPT_DIR/.venv/bin/activate" ]]; then
    source "$SCRIPT_DIR/.venv/bin/activate"

    info "Exporting SVG..."
    python3 -m src.export -q 2>/dev/null && success "SVG export done" || warn "SVG export failed"

    info "Exporting PDF..."
    python3 -m src.pdf_export 2>/dev/null || warn "PDF export failed"

    # Optional sync
    if [[ -f "$SCRIPT_DIR/sync.toml" ]]; then
        info "Running sync..."
        python3 -m src.sync -q 2>/dev/null && success "Sync done" || warn "Sync failed"
    fi
fi

echo ""
success "Backup complete"
